Required knowledge: [[1. Concept - DevTools HTML as entry, Create DevTool Panel and SideBar Pane]]

This tutorial will walkthrough the code but you must have underlying knowledge of how Chrome Extension organizes DevTool features.

---


We will create a Chrome Extension to demonstrate Chrome Extension DevTools' abilities

### Sneak Peak: DevTools Panel

The DevTools panel we code shows inversion of color in the panel after setTimeout of 2 seconds:

A/B - Just opened DevTools panel:
![[Pasted image 20250404015031.png]]

B/B - After waiting 2 seconds:
![[Pasted image 20250404015207.png]]

Clicking the "Invert Inspected Window" shows the DevTools panel can affect web content at the active current tab:
![[Pasted image 20250404015351.png]]

Concept Review:
Refreshing doesn’t restart the process of going from black div to inverting to a white div. In fact, you have to reopen the devtools with a CMD+J then switching to the DevTools_Panel tab (if the final tab, you can press CMD+[ to switch to the final tab)

---

### Sneak Peak: DevTools Elements Sidebar Pane

The DevTools sidepanel we code add border and shadows to elements we select:

A/C - Selecting the element by selecting the HTML row in Elements tab:
![[Pasted image 20250404015644.png]]

B/C - Or inspecting the element in the window (aka inspected window) - CMD+Shift+C, then click element on webpage:
![[Pasted image 20250404015836.png]]

C/C - Clicked "Toggle border", "Toggle shadow", and "Animate wiggle"
- The element we've selected or inspected have now been styled with a thin border, casts a shadow in the background, and it wiggles:

- a/b
  ![[Pasted image 20250404020214.png]]

- b/b
  ![[Pasted image 20250404020006.png]]

---


## Setup

### Folder organization:
```
.
├── assets-framework-css
│   ├── animations.css
│   ├── bootstrap.bundle.min.js
│   ├── bootstrap.min.css
│   └── tailwind.min.css
├── assets-icons
│   ├── icon.png
│   ├── icon128x128.png
│   ├── icon16x16.png
│   ├── icon32x32.png
│   └── icon48x48.png
├── devt-panel.html
├── devt-panel.js
├── devt-sidebar.html
├── devt-sidebar.js
├── init-devtools-panel.js
├── init-devtools-sidebar.js
├── init-devtools.html
├── init-devtools.js
├── manifest.json
└── popup.html
```

### icons
Generate the icons and place them into assets-icons/ instead of the root of the chrome extension files. In previous challenges, we simply placed the icon files at the root, however that is unwise for Chrome Extension DevTools development because it can get too many files quickly.

### manifest.json:
```
{
    "name": "DevTools Chrome Extension",
    "description": "By Weng Fei Fung. Various demo's to teach you how to build a chrome extension to enhance the DevTools that web developers use.",
    "manifest_version": 3,
    "version": "1.0",
    "icons": {
        "16": "assets-icons/icon16x16.png",
        "32": "assets-icons/icon32x32.png",
        "48": "assets-icons/icon48x48.png",
        "128": "assets-icons/icon128x128.png"
    },
    "content_security_policy": {
        "extension_pages": "default-src 'self'; script-src 'self'; object-src 'self'; style-src 'self'; img-src 'self' *; connect-src 'self'"
    },
    "permissions": [
        "activeTab",
        "tabs",
        "scripting"
      ],
    "host_permissions": [
        "http://*/*",
        "https://*/*",
        "<all_urls>"
    ],
    "action": {
        "default_icon": "assets-icons/icon.png",
        "default_popup": "popup.html"
    },
    "web_accessible_resources": [
        {
          "resources": [
                          "assets-framework-css/*"
                        ],
          "matches": ["<all_urls>"]
        }
      ],
    "devtools_page": "init-devtools.html"
}
```

^ We have a popup action, mostly to have a popup appear to remind users that the chrome extension is accessed through DevTools (CMD+SHIFT+I or CMD+SHIFT+J). Chrome users expect most Chrome Extensions to affect the webpage or that to use the chrome extension you have to click its icon. In addition, DevTool chrome extensions are not as common at the Web Store.

^ `devtools_page` points to a html file (in this case `init-devtools.html`) that loads in the js file(s) to help initiate the different devtool presentations and also to listen for any messages (`onMessage`) from them throughout the DevTools' use. Its html DOM elements are ignored and never rendered. What matters is the js files it loads. The js files can programmatically point to and initiate DevTool Panel and/or DevTool Elements Sidebar Pane. The reason why Google decided to use the html file as an entry point is that it gives you the flexibility of splitting devtools.js into multiple js files for your organization/modularization purposes.

^ `web_accessible_resources` is giving permissions to the web content at the active current tab to load in css files from your chrome extension files. 
- In-depth FYI (not important): It's technically **not** required because we're not injecting `<link>` tags into the web content that makes the webpage have to fetch a cross-domain resource (`<link href="chrome-extension://${chrome.runtime.id}/assets-framework-css/animations.css"...`). Instead we are using `chrome.scripting.insertCSS` that injects the css instead (You can see screenshot below). If Google's intention was to prevent the loading of malicious code from a chrome extension, then they have overlooked something. So in the future, the web accessible resources may be required for injections (`chrome.scripting.insertCSS`). Regardless, it's good practice to be explicit about the Chrome extension css/js resources that you're loading into the web content.

> [!note] Injected css for "Animate Wiggle"
> Notice that the source for ".wiggle" is injected rather than pointing to a style block or a css file:
> ![[Pasted image 20250404002101.png]]
> 
> The css file from the chrome extension files that got injected into the web content is `assets-framework-css/animations.css`. It contains styling and animation css so that these buttons work to affect the web content:
> ![[Pasted image 20250404002233.png]]
> 


### Create popup.html:
- You probably don't need to remind them what shortcut to open the DevTools because if they were searching for a DevTools extension, they probably already know how to use DevTools and is looking to enhance their DevTools.
```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Designer and Coder Tools</title>
    <style>
        body {
            width:350px;
            height:85px;
        }
        .float-end {
            float:right;
        }
    </style>
</head>
<body>
    <h3 style="padding-bottom: 0; margin-bottom: 3px;">DevTools Demo</h3>

    <p>
        Open DevTools to see new panel tabbed as "DevTools_Panel". Open Elements panel to see new sidebar pane tabbed as "DevTools_Sidebar".
    </p>

    <p class="float-end">
        - Weng
    </p>
    
</body>
</html>
```

### Create `init-devtools.html` entry point:
```
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
  </head>
  <body>
    <script src="init-devtools-panel.js"></script>
    <script src="init-devtools-sidebar.js"></script>
    <script src="init-devtools.js"></script>
  </body>
</html>
```


### Create the three js files that the entry point is broken into:

We decide we will create both DevTools Panel and DevTools Elements Sidebar Pane

#### init-devtools-panel.js:
```
let panelWindow = null;

chrome.devtools.panels.create("DevTools_Panel", "icon.png", "devt-panel.html", panel => {

    // Code invoked on panel creation
    panel.onShown.addListener((window) => {
        panelWindow = window;
        
    }); // shown panel

});
```

#### init-devtools-sidebar.js:
```
let sidebar = null;

// Initialize the sidebar for the Elements panel
chrome.devtools.panels.elements.createSidebarPane("DevTools_Sidebar", (mySidebar) => {
    // Set the HTML file for the sidebar
    mySidebar.setPage('devt-sidebar.html');
    
    // Code invoked on panel creation
    mySidebar.onShown.addListener((sidebarWindow) => {
        console.log("DevTools_Sidebar is shown");
        sidebar = sidebarWindow;
    });
    
    // Log when the sidebar is hidden
    mySidebar.onHidden.addListener(() => {
        console.log("DevTools_Sidebar is hidden");
    });

    sidebar = mySidebar;
});
```

#### init-devtools.js:
```
// On selection change in Elements panel or Inspected Window
chrome.devtools.panels.elements.onSelectionChanged.addListener((info) => {
    // Assure it's an element selection instead of a DevTools item selection
    chrome.devtools.inspectedWindow.eval(`
        (()=>{
            return {
                url: window.location.href,
                outerHTML: $0.outerHTML
            };
        })()
    `, (result, isException) => {
        if (isException) {
            console.log(`Error inspecting/selecting element: ${result}`);
            // alert("Error selecting element");
            return;
        }
        const {outerHTML, url} = result;
        
        let inspectedWindow = chrome.devtools.inspectedWindow
        console.log("\n")
        console.log("%celements.onSelectionChanged", "font-weight:bold;");
        console.log("The inspected window and tab are:");
        console.log(`- tabId: ${inspectedWindow.tabId}`);
        console.log(`- url: ${url}`);
        console.log("The element selected in the Elements panel is:");
        console.log(`- outerHTML: ${outerHTML}`);
        console.log("\n");

    });
}); // elements.onSelectionChanged


// DevTools background listening for messages from devt-panel.html and devt-sidebar.html
chrome.runtime.onMessage.addListener(async function(request, sender, sendResponse) {
    switch(request.type) {

        // region Messages from devt-panel.html
        case "pn2dt-invert-panel-colors":
            console.log("devTools.js responds to 'invert-colors' message and hears the payload oldClasses and newClasses");
            console.log({oldClasses: request.oldClasses});
            console.log({newClsases: request.newClasses});

            var document = panelWindow.document; // panelWIndow is from outside scope
            document.querySelector("#main").classList.remove(...request.oldClasses);
            document.querySelector("#main").classList.add(...request.newClasses);

            break;
        
        case "pn2dt-invert-inspected-window-colors":
            invertInspectedWindowColors();
            break;
        // endregion

        // region Messages from devt-sidebar.html
        case "sb2dt-toggle-border":
            chrome.devtools.inspectedWindow.eval(`
                if($0.classList.contains("border-black")) {
                    $0.classList.remove("border-black");
                    $0.classList.remove("border");
                } else {
                    $0.classList.add("border-black");
                    $0.classList.add("border");
                }
            `, (result, isException) => {
                if (isException) {
                    console.error("Error toggling border:", isException);
                }
            });
            break;

        case "sb2dt-toggle-shadow":
            chrome.devtools.inspectedWindow.eval(`
                $0.classList.toggle("shadow-lg");
            `, (result, isException) => {
                if (isException) {
                    console.error("Error toggling shadow:", isException);
                }
            });
            break;

        case "sb2dt-animate-fade-in-out":
            chrome.devtools.inspectedWindow.eval(`
                $0.classList.add("fade-out-in");
            `, (result, isException) => {
                if (isException) {
                    console.error("Error toggling shadow:", isException);
                }
            });
            setTimeout(()=>{ 
                chrome.devtools.inspectedWindow.eval(`
                    $0.classList.remove("fade-out-in");
                `, (result, isException) => {
                    if (isException) {
                        console.error("Error toggling shadow:", isException);
                    }
                });
             }, 2010);
            break;

        case "sb2dt-animate-wiggle":
            chrome.devtools.inspectedWindow.eval(`
                $0.classList.add("wiggle");
            `, (result, isException) => {
                if (isException) {
                    console.error("Error toggling shadow:", isException);
                }
            });
            setTimeout(()=>{ 
                chrome.devtools.inspectedWindow.eval(`
                    $0.classList.remove("wiggle");
                `, (result, isException) => {
                    if (isException) {
                        console.error("Error toggling shadow:", isException);
                    }
                });
             }, 3010);
            
            break;
        case "sb2dt-toggle-visibility":
            chrome.devtools.inspectedWindow.eval(`
                $0.classList.toggle("invisible");
            `, (result, isException) => {
                if (isException) {
                    console.error("Error toggling shadow:", isException);
                }
            });
            break;
            
        case "sb2dt-toggle-display":
            chrome.devtools.inspectedWindow.eval(`
                $0.classList.toggle("hidden");
            `, (result, isException) => {
                if (isException) {
                    console.error("Error toggling shadow:", isException);
                }
            });
            break;

        case "sb2dt-invert-inspected-window-colors":
            invertInspectedWindowColors();
            break;
        
        case "sb2dt-request-inspected-element":
            // Return true to indicate we'll send a response asynchronously
            getInspectedElement().then(elementInfo => {
                console.log("Inspected element requested:", elementInfo);
                chrome.runtime.sendMessage({type:"dt2sb-response-inspected-element", data: elementInfo ? elementInfo.innerText : "No element selected"});
                });
            break;
        // endregion

    } // switch
}); // addListener

/**
 * Gets information about the currently inspected element
 * @returns {Promise<Object|false>} Object with element info or false if no element is selected
 */
function getInspectedElement() {
    return new Promise((resolve) => {
        chrome.devtools.inspectedWindow.eval(`
            (function() {
                if ($0) {
                    return {
                        tagName: $0.tagName,
                        id: $0.id,
                        className: $0.className,
                        outerHTML: $0.outerHTML,
                        innerHTML: $0.innerHTML,
                        innerText: $0.innerText || $0.textContent || "",
                        attributes: Array.from($0.attributes).map(attr => ({
                            name: attr.name,
                            value: attr.value
                        })),
                        rect: $0.getBoundingClientRect().toJSON()
                    };
                } else {
                    return false;
                }
            })();
        `, (result, isException) => {
            if (isException) {
                console.error("Error getting inspected element:", isException);
                resolve(false);
            } else {
                resolve(result);
            }
        });
    });
}


function invertInspectedWindowColors() {
    console.log("devTools.js responds to '..invert-inspected-window-colors' message");

    chrome.devtools.inspectedWindow.eval(`
        document.body.style.filter = "invert(1)";
    `, (result, isException) => {
        if (isException) {
            console.error("Error inverting inspected window colors:", isException);
        }
    });
}
```

### Create a DevTools Panel

#### devt-panel.html:
```
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>DevTools Panel</title>
    <link href="assets-framework-css/tailwind.min.css" rel="stylesheet">
  </head>
  <body>
    <h2 class="text-2xl font-bold my-4 text-center">DevTools Panel</h2>
    <main id="main" class="bg-gray-900 text-white p-8 rounded-lg shadow-lg max-w-2xl mx-auto my-8">
        <p class="text-gray-300 leading-relaxed">
          Colors in this div inverts after 2 seconds from loading.
        </p>
        <p class="text-gray-300 leading-relaxed mt-4">
          devt-panel.html's js setTimeouts for 2 seconds, then emits a message 'invert-colors' with payload oldClasses and newClasses.
          devtools.js listens for 'invert-colors' message and hears the payload oldClasses and newClasses, queries the document for #main, and from it, removes the oldClasses and adds the newClasses.
        </p>
    </main>

    <button id="invert-inspected-window-colors" class="block bg-gray-500 text-white px-4 py-2 rounded-md mx-auto">Invert Inspected Window</button>

    <script src="devt-panel.js"></script>
  </body>
</html>
```

#### devt-panel.js:

```
console.log("DevTools Panel loaded");
setTimeout(() => {
    console.log("DevTools Panel 2 seconds later...");
    console.log("DevTools Panel sends message 'invert-colors' globally, then devtools.js listens for it");
    chrome.runtime.sendMessage({type:"pn2dt-invert-panel-colors", oldClasses:["bg-gray-900", "text-white"], newClasses:["text-gray-900", "bg-white"]});
}, 2000);

document.querySelector("#invert-inspected-window-colors").addEventListener("click", () => {
    console.log("DevTools Panel sends message 'invert-colors' globally, then devtools.js listens for it");
    chrome.runtime.sendMessage({type:"pn2dt-invert-inspected-window-colors"});
});
```

### Create a DevTools Elements Sidebar Pane

#### devt-sidebar.html
```
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>DevTools Sidebar</title>
    <link href="assets-framework-css/tailwind.min.css" rel="stylesheet">
  </head>
  <body>
    <h3 class="text-2xl font-bold my-4 text-center text-black">DevTools Sidebar</h3>

    <main id="main" class="max-w-md mx-auto p-4 space-y-4">
        <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4">
            <p class="text-yellow-700 text-sm">
                Note: These tools will affect the currently selected element at the Elements panel or the inspected window.
            </p>
        </div>
        <div id="status-inject-css-files-into-content" class="text-sm text-gray-600 italic bg-gray-100 rounded-md p-3 border border-gray-200"></div>
        <div class="grid grid-cols-2 gap-4">
            <button id="toggle-border" class="btn-sidebar hidden bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm">
                Toggle border
            </button>
            <button id="toggle-shadow" class="btn-sidebar hidden bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md text-sm">
                Toggle shadow
            </button>
            <button id="animate-fade-in-out" class="btn-sidebar hidden bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm">
                Animate fade out in
            </button>
            <button id="animate-wiggle" class="btn-sidebar hidden bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md text-sm">
                Animate wiggle
            </button>
            <button id="toggle-visibility" class="btn-sidebar hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm">
                Toggle visibility
            </button>
            <button id="toggle-display" class="btn-sidebar hidden bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md text-sm">
                Toggle display
            </button>
        </div>

        <div class="info-spacer pt-4"></div>

        <div class="border-t">
            <button id="invert-sidebar-window-colors" class="w-full bg-gray-500 hover:bg-gray-300 text-white px-4 py-2 rounded-md text-sm">
              Invert Sidebar Window
            </button>
        </div>

        <div class="border-t">
            <button id="invert-inspected-window-colors" class="w-full bg-gray-500 hover:bg-gray-300 text-white px-4 py-2 rounded-md text-sm">
              Invert Inspected Window
            </button>
        </div>

        <div class="border-t">
            <button id="get-inspected-element" class="w-full bg-gray-300 hover:bg-gray-100 text-black px-4 py-2 rounded-top-left-md rounded-top-right-md  text-sm">
             Request text of inspected element
            </button>
            <div id="status-inspected-element" class="text-sm text-gray-600 italic bg-gray-100 rounded-botom-left-md rounded-bottom-right-md p-3 border border-gray-200"></div>
        </div>

    </main>

    <script src="devt-sidebar.js"></script>
  </body>
</html>
```

#### devt-sidebar.js
```
async function insertCDNs(doneCallback) {
    await chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
        let tab = tabs[0];
        
        chrome.scripting.insertCSS({
            target: {tabId: tab.id},
            files: ['assets-framework-css/bootstrap.min.css', 'assets-framework-css/tailwind.min.css', 'assets-framework-css/animations.css']
        });

        chrome.scripting.executeScript({
            target: {tabId: tab.id},
            files: ['assets-framework-css/bootstrap.bundle.min.js']
            });
        console.log("CSS and JS injected for Bootstrap 5 / Tailwind 2.")
        console.log("CSS injected for animations fade-in-fade-out and wiggle.")
    });
    doneCallback();
}; // insertCDNs

function revealButtonsInBatches() {
    const hiddenElements = document.querySelectorAll('.btn-sidebar.hidden');
    let index = 0;

    const interval = setInterval(() => {
      const batch = Array.from(hiddenElements).slice(index, index + 2);
      if (batch.length === 0) {
        clearInterval(interval); // Stop when no more hidden elements
        return;
      }

      batch.forEach(el => el.classList.remove('hidden'));
      index += 1;
    }, 300);
} // revealButtonsInBatches

document.addEventListener("DOMContentLoaded", function() {
    insertCDNs(()=>{
        document.querySelector("#status-inject-css-files-into-content").innerHTML = "<b>Ready</b>.CSS and JS injected for Bootstrap 5 / Tailwind 2. CSS injected for animations fade-in-fade-out and wiggle."
    });
    
    revealButtonsInBatches();

    document.querySelector("#toggle-border").addEventListener("click", () => {
        chrome.runtime.sendMessage({type:"sb2dt-toggle-border"});
    });
    
    
    document.querySelector("#toggle-shadow").addEventListener("click", () => {
        chrome.runtime.sendMessage({type:"sb2dt-toggle-shadow"});
    });
    
    
    document.querySelector("#animate-fade-in-out").addEventListener("click", () => {
        chrome.runtime.sendMessage({type:"sb2dt-animate-fade-in-out"});
    });
    
    
    document.querySelector("#animate-wiggle").addEventListener("click", () => {
        chrome.runtime.sendMessage({type:"sb2dt-animate-wiggle"});
    });
    
    
    document.querySelector("#toggle-visibility").addEventListener("click", () => {
        chrome.runtime.sendMessage({type:"sb2dt-toggle-visibility"});
    });
    
    
    document.querySelector("#toggle-display").addEventListener("click", () => {
        chrome.runtime.sendMessage({type:"sb2dt-toggle-display"});
    });
  
    document.querySelector("#invert-sidebar-window-colors").addEventListener("click", () => {
        document.querySelector("#main").style.filter = "invert(1)";
    });

    document.querySelector("#invert-inspected-window-colors").addEventListener("click", () => {
        chrome.runtime.sendMessage({type:"sb2dt-invert-inspected-window-colors"});
    });

    document.querySelector("#get-inspected-element").addEventListener("click", () => {
        chrome.runtime.sendMessage({type:"sb2dt-request-inspected-element"}, (response) => {
          console.log(`response: ${response}`);
        });
    });
    
});

chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    switch(request.type) {
        case "dt2sb-response-inspected-element":
            document.querySelector("#status-inspected-element").innerHTML = request.data;
            break;
    }
});
```

### Create Injected CSS Files

Finally, we create the files at:
```
├── assets-framework-css
│   ├── animations.css
│   ├── bootstrap.bundle.min.js
│   ├── bootstrap.min.css
│   └── tailwind.min.css
```

Note that the main reasons for these css files is that the Elements sidebar pane will allow you to modify the style or add animation to the element selected in Elements panel or in the inspected window.

#### animations.css:
- This makes it possible for animation classes that get added to web content's selected/inspected element when clicking animate buttons at the sidebar:
```
.fade-out-in {
    animation: fadeOutIn 2s ease-in-out;
}

@keyframes fadeOutIn {
    0% {
        opacity: 1;
    }
    45% {
        opacity: 0;
    }
    55% {
        opacity: 0;
    }
    100% {
        opacity: 1;
    }
}


@keyframes wiggle {
    0%, 100% {
        transform: rotate(0deg);
    }
    25% {
        transform: rotate(-5deg);
    }
    75% {
        transform: rotate(5deg);
    }
}

.wiggle {
    animation: wiggle 0.5s ease-in-out 3;
}

```

#### bootstrap.bundle.min.js

Terminal Cd into the css folder. We will curl in a bit:
```
cd assets-framework-css
```

Then curl for the Bootstrap minified js:
```
curl -o bootstrap.bundle.min.js https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js
```

#### bootstrap.min.css

Terminal cd into the css folder if you're not in there anymore.

Then curl for the Bootstrap minified css:

```
curl -o bootstrap.min.css  https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css
```

#### tailwind.min.css

Terminal cd into the css folder if you're not in there anymore.

Then curl for the Tailwind minified css:
```
curl -o tailwind.min.css  https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css
```


#### Double check

The resulting css assets folder structure should be:
```
├── assets-framework-css
│   ├── animations.css
│   ├── bootstrap.bundle.min.js
│   ├── bootstrap.min.css
│   └── tailwind.min.css
```


---

Install the chrome extension and play around with it to get a feel of its features. Remember that the features are accessed in DevTools (CMD+Shift+I or CMD+Shift+J)

Clicking the Chrome extension will open a popup to remind you:
![[Pasted image 20250404030141.png]]

Review how the DevTool features work because soon we will discuss how the code flows. If you need a quick review, refer to the sections near the top:
- Sneak Peak: DevTools Panel
- Sneak Peak: DevTools Elements Sidebar Pane

---

### Discussion

We will discuss how the code flows between files and how the features are implemented. To keep the tutorial short, I won't be rewriting the code into this section. You're encouraged to open the files to read along the code as instructed.

#### Entry point and loading of presentations

The entry point init-devtools.html is opened so that the three init devtools.js can run (or you could have all of them in one devtools.js file which is how it's traditionally done). All renderings are ignored.

init..panel.js loads in devt-panel.html for a DevTools panel. init..sidebar.js loads in devt-sidebar.html for a sidebar pane if you're on the Elements panel. Therefore, two new tabs are also created in the DevTools and they are "DevTools_Panel" and "DevTools_Sidebar". See these two screenshots:


| ![[Pasted image 20250404015031.png]]<br>         | ![[Pasted image 20250404015644.png]]   |
| ------------------------------------------------ | -------------------------------------- |
| Panel. Alongside Elements tab, Console tab, etc. | Sidebar. Associated with Elements tab. |

#### Panel

Open devt-panel.html. You see that tailwind local css file is loaded in, so that tailwind classes can work immediately. You see a #main section that has a bunch of instructions. You see a button that hints at inverting the inspected window's button. And you see the js file loaded at the end of the body (`devt-panel.js`)

As a DevTools user, opening the panel, you see this frontend effect:

| ![[Pasted image 20250404015031.png]]<br>                                       | ![[Pasted image 20250404015207.png]]<br>                                            |
| ------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------- |
| When you first open the panel from a fresh DevTools session (CMD+SHIFT+J or I) | Then 2 seconds later, the panel's main message changes colors inverting themselves. |

That's because in devt-panel.js , there's a setTimeout for 2 seconds, then a message gets emitted `pn2dt-invert-panel-colors` (panel to devtools is the conventional prefix here) along with data oldClasses and newClasses. init-devtools.js which acts like the background.js of Devtools pages - it responds to that message and receives oldClasses and newClasses. Using the `panelWindow` that it has access to because of the load order of js files at entry point `init-devtools.html`, it gets access to `panelWindow.document` so that it queries for the #main section at the devt-panel.html layout, then it removes the old tailwind classes (in the array oldClasses) and adds the new tailwind classes (in the array newClasses), effectively changing the background and text colors, inverting the colors.

When you click "Invert Inspected Window" button at the panel, devt-panel.html's devt-panel.js's click event listener gets executed. It emits the message `pn2dt-invert-inspected-window-colors`. The `init-devtools.js` responds to that message by calling function `invertInspectedWindowColors` which runs against the inspectedWindow by adding a filter `invert(1)`. This is a much sweeter way of inverting colors instead of removing old classes and adding new classes.

The functionalities of DevTool panel has been discussed. It demonstrates that the DevTool panel html can load in css files. It demonstrates that the panel's js can message out to be picked up by devtools.js, and that devtools.js can affect the DevTool panel's html (although it would be easier to querySelector on the document directly at DevTool panel's js file `devt-panel.js`). We kept to the convention of having a message relay system so init-devtools.js performed the layout changes on DevTools panel.

#### Sidebar

Just like DevTools panel, the DevTools sidebar html has link href to a local tailwind css file. That allowed us to code the sidebar easily without needing additional custom css files. But we're limited to tailwind 2.2.19 because the newer tailwind uses JIT instead of css files, which would complicate our code for Chrome Extension.

On Chrome, open up our sidebar by opening the Elements panel, then at the sidebar, open up the "DevTools_Sidebar" tab:
![[Pasted image 20250404015644.png]]

You'll see the buttons animate from top to bottom by "popping in" to existence row by row. This happens because of devt-sidebar.html's devt-sidebar.js. Before we can explain the js for the popping in animation, we have to discuss some other logic.

At the top of the js files are two functions insertCDNs and revealButtonsInBatches. After them is DomContentLoaded, which will call insertCDNs and pass it a finish callback function to change #status-inject-css-files-into-content message to it being ready because CSS and JS are injected. The insertCDNs actually inject css and js files directly into the web content at the active current tab using `chrome.scripting.insertCSS` and `chrome.scripting.executeScript with files property`. You'll notice the message at the sidebar in the gray box that it's ready because of the finish callback after successful injection:
![[Pasted image 20250404175246.png]]
You'll also notice the console logs that are part of the function insertCDNs. Right click and inspect on the sidebar. The main console won't display the console logs. You'll see logs from:
```
        console.log("CSS and JS injected for Bootstrap 5 / Tailwind 2.")
        console.log("CSS injected for animations fade-in-fade-out and wiggle.")
```

Next, we can discuss the "popping in" animation of rows of buttons. That's due to `revealButtonsInBatches` which is ran after `insertCDNs`. What the reveal function does is doing is for all ".btn-sidebar"'s reveal two at a time using a combination of slicing and setIntervals.

Afterwards, the rest of the code attaches click event listeners to the buttons:
![[Pasted image 20250404175811.png]]

The usual pattern is user clicks the button. Then devt-sidebar.js onclick listeners emits a message. For example, if user clicks "Toggle border" button, it emits a message "sb2dt-toggle-border", then init-devtools.js responds by toggling a tailwind class. This allows pressing a button to affect the selected/inspected element's style. Remember you had to have selected an element using either the Elements panel (clicking a row of element code) or in CMD+SHIFT+C mode you have clicked an element on the webpage with the Elements panel opened. An element must be selected/inspected for the button to apply styles too.

The animate fade out in and animate wiggle buttons have a slightly different code flow. In addition to adding the classes fade-out-in or wiggle, it setTimeout to remove the class after a few seconds. This allows subsequent clicks where the animation can play again because we're adding the class to an element without that class - that is because the css doesn't have the animation loop infinitely. The fade-out-in and wiggle classes are not from the local tailwind css file but from the local animation.css, which has been loaded in from insertCDNs.

Now let's focus on the miscellaneous buttons at the bottom of the sidebar:

![[Pasted image 20250404175820.png]]

devt-sidebar.js has onclick listener for invert sidebar window that will modify the document directly by query selecting the document for #main section, then adding a filter of `invert(1)` to its style: `document.querySelector("#main").style.filter = "invert(1)";`, effectively inverting the colors on background and text of the sidebar. Usually we send out messages to init-devtools.js to perform frontend changes instead of having the presentation's js perform frontend changes more locally. Here we do it differently here so that we can contrast with the "Invert Inspected Window"'s approach of having `init-devtools` as a main message relay and renderer, just to show there's more than one way to affect rendering of the web content from user interactions at a DevTools presentation.

However, you could've had devt-sidebar.js emit a message for init-devtools.js to respond to. Then the response is to modify sidebar's document because when you init sidebar at init-devtools-sidebar.js, you saved an instance of the sidebar before loading init-devtools.js, so there is global access to sidebar window object from init-devtools.js:
```
chrome.runtime.onMessage.addListener(async function(request, sender, sendResponse) {
	switch(request.type) {
		// ...  
		case "sb2dt-invert-sidebar-window-colors":
			sidebar.document.body.style.filter = "invert(1)";
			break;
		// ...
	} // switch
}); // addListener
```

Clicking the "Invert Inspected Window" button has the devt-sidebar.js emit a message `sb2dt-invert-inspected-window-colors`, which init-devtools.js picks up on, and init-devtools.js does the following:
- calls invertInspectedWindowColors()
- invertInspectedWindowColors() runs against inspectedWindow, adding to the document body's style a filter of `invert(1)`, effectively inverting the colors on background and text of the web content at the current active tab.

Final feature to cover is "Request text of inspected element" button. Clicking the button will trigger event handler `sb2dt-request-inspected-element` at devt-sidebar.js. The event handler emits a message `sb2dt-request-inspected-element`, which `init-devtools.js` picks up, then using getInspectedElement() which is a wrapper for evaluating against inspectedWindow, it gets properties of the inspected/select element. Then `init-devtools.js` emits message `dt2sb-response-inspected-element` with the element text. The devt-sidebar.js calls to action to the message by writing the delivered innerText to the div #status-inspected-element underneath that button. This demonstrates that the message relaying can be both directions between a DevTools presentation and init-devtools.js.

A/B - Selected element:
![[Pasted image 20250404193058.png]]

B/B - Retrieved inner text (See bottom right)
![[Pasted image 20250404193108.png]]

The mermaid code/diagram:
```
sequenceDiagram
    participant Sidebar as Sidebar (devt-sidebar.js)
    participant DevTools as DevTools (init-devtools.js)

    note over Sidebar, DevTools: User clicks Sidebar button to get text of selected/inspected element
    Sidebar->>DevTools: Send message "sb2dt-request-inspected-element"
    DevTools->>DevTools: getInspectedElement() for innerText
    DevTools-->>Sidebar: Send message "dt2sb-response-inspected-element" (with payload innerText)
    Sidebar->>Sidebar: Update #status-inspected-element
    note over Sidebar, DevTools: User sees text of the selected/inspected element reported at Sidebar.
```

![[Pasted image 20250404190055.png]]

This concludes the discussion.

## Concepts to highlight

- That devtools.js becomes the main relay for all Devtools panel and sidebar to message to, then devtools.js responds to the message. This is much like how background.js worked from the previous challenges folders that were for presentations that are not part of DevTools.

- Namesake of Inspected Window: When DevTools is opened, the webpage at the active tab is called the Inspected window, because you can inspect and click individual elements on the webpage for their HTML, css, etc.
We will create a side panel extension that gives basic information along with a screenshot, of the website at the current active tab.

## Setup

Create icon files set and manifest.json file. You should know how by now.

Create manifest.json with these contents:
```
{  
    "manifest_version": 3,  
    "name": "<APP_NAME>",  
    "version": "1.0",  
    "description": "<APP_DESCRIPTION>.",  
    "author": "Weng Fei Fung",
    "icons": {  
        "16": "icon16x16.png",  
        "32": "icon32x32.png",  
        "48": "icon48x48.png",  
        "128": "icon128x128.png"  
    },
    "content_security_policy": {  
        "extension_pages": "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; object-src 'self';"
    },
    "permissions": [
        "sidePanel", "scripting", "tabs", "activeTab"
    ],
    "action": {  
        "default_icon": "icon.png"
    },
	"background": {
	    "service_worker": "background.js"
    },
    "side_panel": {
        "default_path": "sidepanel.html"
    },
    "host_permissions": [
        "https://*/*",
        "http://*/*"
    ]
}
```

^ We've added a `data:` as an img-src CSP because we'll be capturing a screenshot of the website at the current active tab and placing it into the side panel.


Create sidepanel.html:
```
<!DOCTYPE html>
<html>
<head>
    <title>Options</title>
</head>

<body>
    <h1>Side Panel</h1>
    <div id="report"></div>

    <script src="sidepanel.js"></script>
</body>

</html>
```


Create sidepanel.js...
Which is used by sidepanel.html:
```
// About to finish loading, send a message to the service worker that it's finished loading
chrome.runtime.sendMessage({action: "sidepanel-domcontentloaded"});

// Data for html is received from background.js because side panel page DOM is finished loading and unlocked
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
    console.log("Message received in sidepanel:", message);
    if (message.action === "sidepanel-dynamic-data") {
        
        console.log("Message of dynamic data received in sidepanel:", message);
        const {payload} = message;
        const {screenshotBase64Url} = message;
        
        const reportEl = document.getElementById("report")

        reportEl.innerHTML = "";
        reportEl.innerHTML += `<b>Site Stats:</b><br/>`;

        reportEl.innerHTML += (()=>{
            let str = "";
            for (const [key, value] of Object.entries(payload)) {
                str+=`${key}: ${value}</br>`
            }
            return str;
        })();

        reportEl.innerHTML += `<br><b>Screenshot:</b><br/>`;

        const imgEl = document.createElement("img");
        imgEl.src = screenshotBase64Url;
        imgEl.style.width = "100%";
        imgEl.style.height = "100%";
        imgEl.style.objectFit = "contain";

        reportEl.appendChild(imgEl);
    }
});
```

Create background.js...
Which helps coordinate the user clicking the chrome extension icon and the stats loading in the sidepanel that subsequently finishes loading (page needs to finish loading before we start writing to it):
```
// About to finish loading, send a message to the service worker that it's finished loading
chrome.runtime.sendMessage({action: "sidepanel-domcontentloaded"});

// Data for html is received from background.js because side panel page DOM is finished loading and unlocked
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
    console.log("Message received in sidepanel:", message);
    if (message.action === "sidepanel-dynamic-data") {
        
        console.log("Message of dynamic data received in sidepanel:", message);
        const {payload} = message;
        const {screenshotBase64Url} = message;
        
        const reportEl = document.getElementById("report")

        reportEl.innerHTML = "";
        reportEl.innerHTML += `<b>Site Stats:</b><br/>`;

        reportEl.innerHTML += (()=>{
            let str = "";
            for (const [key, value] of Object.entries(payload)) {
                str+=`${key}: ${value}</br>`
            }
            return str;
        })();

        reportEl.innerHTML += `<br><b>Screenshot:</b><br/>`;

        const imgEl = document.createElement("img");
        imgEl.src = screenshotBase64Url;
        imgEl.style.width = "100%";
        imgEl.style.height = "100%";
        imgEl.style.objectFit = "contain";

        reportEl.appendChild(imgEl);
    }
});
```


---

## Discussion

How the logic flows is as follows:
1. When user clicks the chrome extension icon, the background.js listens for and responds to onClicked by opening the sidepanel with `chrome.sidePanel.open` at the current window.
2. When sidepanel.html near finishes loading, its sidepanel.js sends a message "sidepanel-domcontentloaded"
3. The background.js listens for and responds to "sidepanel-domcontentloaded" and then performs an active tab query to get information about the active tab (title, url, favIcon, etc). Also, it takes a screenshot (part of Chrome's Tabs API!) and saves as a screenshot base 64 url. All this data is saved in payload. Next, an executeScript is run against the active tab in order to query for all \* elements and count their length, in other words, get the number of elements that are on the webpage. So all this information gathered in a message "sidepanel-dynanic-data" is sent to the entire chrome extension environment.
4. The sidepanel.js listens for and responds to "sidepanel-dynamic-data", and then receiving the information gathered from background.js, it renders the sidebar stats to the user.

Two important new lessons here is that:
- A javascript file that sidepanel.html uses (but not pointed to by manifest.json) still has access to the chrome messaging system because sidepanel.js responds to the message "sidepanel-dynamic-data".
- That `await chrome.scripting.executeScript` can return results to the outer scope (though the returned data is in a wrapper object so you have to use the dot notation to access the returned value - refer to comments in the code at background.js for executeScript).


Mermaid diagram (fyi):
```
sequenceDiagram
    participant User
    participant ChromeExtension as Chrome Extension (icon)
    participant BackgroundJS as background.js
    participant SidePanel as sidepanel.html + sidepanel.js
    participant ActiveTab as Active Tab

    User->>ChromeExtension: Clicks extension icon
    ChromeExtension->>BackgroundJS: onClicked event
    BackgroundJS->>SidePanel: chrome.sidePanel.open()

    SidePanel-->>BackgroundJS: Message "sidepanel-domcontentloaded"

    Note over BackgroundJS,ActiveTab: Background.js asks active tab to give information back to background.js

    BackgroundJS<<->>ActiveTab: Query active tab info (title, url, favIcon)

    BackgroundJS<<->>ActiveTab: chrome.tabs.captureVisibleTab() → Screenshot

    BackgroundJS<<->>ActiveTab: chrome.scripting.executeScript() → get number of elements
    
    Note over BackgroundJS,ActiveTab: Final steps
    
    BackgroundJS-->>SidePanel: Message "sidepanel-dynamic-data" with payload

    SidePanel->>SidePanel: Render sidebar stats using received data

```

![[Pasted image 20250327233118.png]]

---

## Testing

Update/install the chrome extension. Then at google.com (not a new tab that by default has google opened because page access would be blocked from the extension), click the chrome extension icon to open the side panel and see stats.

![[Pasted image 20250327172744.png]]

You can also test this at any other websites besides google.com